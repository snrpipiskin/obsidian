# Контекст в Go

**Context** — это стандартный механизм для управления временем жизни запросов, передачи сигналов отмены и хранения значений. 

## 1. Интерфейс Context

В основе пакета лежит интерфейс `Context`, который определяет четыре метода:

```go
type Context interface {
    Deadline() (deadline time.Time, ok bool) // Когда контекст будет отменен
    Done() <-chan struct{}                   // Канал для сигнала отмены
    Err() error                              // Причина отмены (Canceled или DeadlineExceeded)
    Value(key any) any                       // Поиск значения по ключу
}
```

---

## 2. Типы контекстов (Внутреннее устройство)

Контексты организованы в виде дерева: отмена родителя всегда приводит к отмене всех его потомков.

### 1. Базовые (emptyCtx)
- **`context.Background()`**: Базовый пустой контекст. Используется как корень дерева в `main` или в начале запроса.
- **`context.TODO()`**: Используется, если неясно, какой контекст нужен, или он еще не реализован.

### 2. С отменой (cancelCtx)
Создается через **`context.WithCancel(parent)`**.
- Возвращает копию родителя и функцию `cancel()`.
- При вызове `cancel()` закрывается канал `Done` и рекурсивно отменяются все дочерние контексты.

### 3. С дедлайном (timerCtx)
Создаются через **`context.WithTimeout`** или **`context.WithDeadline`**.
- Включают в себя механизм `cancelCtx`, но дополнены таймером (`time.AfterFunc`).
- Автоматически вызывают `cancel()` по истечении времени.

### 4. Со значениями (valueCtx)
Создается через **`context.WithValue(parent, key, value)`**.
- Хранит пару "ключ-значение".
- Поиск значения идет **вверх по дереву** (от текущего контекста к корню).

---

## 3. Правила работы с контекстом

Для чистого и предсказуемого кода следует соблюдать правила:
1.  **Первый параметр**: Контекст всегда передается первым аргументом функции: `func DoWork(ctx context.Context, ...)`.
2.  **Не хранить в структурах**: Контекст должен жить в области видимости функции. Хранение в `struct` — антипаттерн (кроме редких исключений для совместимости).
3.  **Не передавать nil**: Если контекст не нужен, используйте `context.TODO()`.
4.  **Явный вызов cancel**: Всегда вызывайте `defer cancel()` после создания контекста с отменой или таймером, чтобы избежать утечек памяти и ресурсов таймера.

---

## 4. Передача значений через WithValue

Используйте `WithValue` только для данных, которые "сопутствуют" запросу, но не являются его параметрами.
- **Хорошо**: RequestID, UserID, метаданные логирования/трассировки.
- **Плохо**: Опциональные параметры функции, конфигурация базы данных.

> [!tip]
> Ключи контекста должны быть **неэкспортируемыми пользовательскими типами** (например, `type ctxKey int`), чтобы избежать коллизий при использовании сторонних библиотек.

---

## 5. Дополнительные источники
- [Документация пакета context](https://pkg.go.dev/context)
- [Статья в блоге Go: Go Concurrency Patterns: Context](https://go.dev/blog/context)
- [[obsidian/База для собесов копия/Темы к собесам/Горутина|Заметка про горутины]] — связь отмены контекста с завершением горутин.