---
noteId: 1771149883713
related:
  - "[[30 Interests/31 Programming/Go/База для собесов/Темы к собесам/Горутина]]"
  - "[[30 Interests/31 Programming/Go/База для собесов/Темы к собесам/Go Runtime]]"
  - "[[Sync.Mutex]]"
---

```go
package main

import (
	"fmt"
	"sync"
)

func main() {
	var max int
    var mx sync.Mutex
    
	for i := 1000; i > 0; i-- {
		go func() {
			mx.Lock()
			if i%2 == 0 && i > max {
				max = i
			}
		}()
	}

	fmt.Printf("Maximum is %d\n", max)
}
```

---

Maximum is 0 (или deadlock)

**Проблемы:**
1. **Deadlock**: `mx.Lock()` без `mx.Unlock()` — все горутины зависнут навсегда
2. **Замыкание**: все горутины используют одну и ту же переменную `i` (к моменту запуска уже `-1` или `0`)
3. **Нет ожидания**: `main` завершается раньше, чем горутины запустятся
4. **Race condition**: чтение `max` без синхронизации

**Исправления:**
```go
var wg sync.WaitGroup
for i := 1000; i > 0; i-- {
    wg.Add(1)
    go func(val int) {
        defer wg.Done()
        mx.Lock()
        defer mx.Unlock()  // ✅ Разлочить
        if val%2 == 0 && val > max {
            max = val  // ✅ Использовать параметр val
        }
    }(i)
}
wg.Wait()  // ✅ Ждать завершения
mx.Lock()
fmt.Printf("Maximum is %d\n", max)
mx.Unlock()
```
