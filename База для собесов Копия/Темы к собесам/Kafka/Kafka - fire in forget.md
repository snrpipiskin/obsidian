---
noteId: 1743196646798
---



![[30 Interests/31 Programming/Go/База для собесов/Темы к собесам/Kafka/Kafka|Kafka]]

### ==**База по Kafka**==

Kafka изначально предназначалась для работы с большим объемом данных и обеспечивает надежную доставку сообщений между сервисами.

### **Идемпотентность**

Идемпотентность — это свойство, при котором повторное выполнение операции не изменяет результата после первого выполнения.

### **Гарантии доставки сообщений в Kafka**

- **At most once (максимум один раз)** — сообщения могут быть потеряны, но не будут повторно доставлены.
    
- **At least once (как минимум один раз)** — сообщения гарантированно будут доставлены, но возможны дублирования.
    
- **Exactly once (ровно один раз)** — каждое сообщение доставляется строго один раз (требует дополнительной настройки).
    
- **Effectively once (эффективно один раз)** — обеспечивает уникальность результата обработки сообщения, даже если оно может быть доставлено более одного раза.
    
- **Idempotent producer (идемпотентный продюсер)** — гарантирует, что дубликаты сообщений не будут записаны в лог из-за повторных попыток.
    

### **Outbox Pattern**

Используется для обеспечения атомарности операций обновления базы данных и отправки сообщений в Kafka.

1. Запись добавляется в таблицу `outbox` вместе с обновлением основной таблицы.
    
2. Отдельный процесс читает записи из `outbox` и публикует их в Kafka.
    
3. После успешной публикации запись удаляется из `outbox`.
    

#### **Преимущества:**

- Обеспечивает согласованность между базой данных и Kafka.
    
- Гарантирует, что сообщение будет отправлено в Kafka даже при сбоях.
    

### **Inbox Pattern**

Используется для обеспечения идемпотентности обработки сообщений на стороне потребителя.

1. При получении сообщения из Kafka оно сначала сохраняется в таблицу `inbox`.
    
2. Проверяется, было ли оно обработано ранее.
    
3. Если сообщение новое, оно обрабатывается и сохраняется в базу данных.
    
4. После успешной обработки его статус в `inbox` обновляется.
    

#### **Преимущества:**

- Предотвращает повторную обработку сообщений.
    
- Позволяет продолжить обработку после сбоев.
    

#### **Комбинация паттернов:**

Использование `Outbox` и `Inbox` вместе позволяет достичь **exactly-once** семантики между микросервисами.

![[Untitled 4.png|Untitled 4.png]]

---

### **Архитектура Kafka**

#### **Продюсер (Producer)**

Продюсер — это компонент, который отправляет сообщения в Kafka.

- Может отправлять сообщения в одну или несколько тем (topics).
    
- Используется для логирования, обмена событиями между сервисами и других задач.
    

#### **Консьюмер (Consumer)**

Консьюмер — это компонент, который читает и обрабатывает сообщения из Kafka.

- Может подписываться на одну или несколько тем и обрабатывать сообщения в соответствии с бизнес-логикой.
    

**Группа консюмеров (Consumer Group)** Kafka позволяет нескольким консьюмерам объединяться в **группу консюмеров**. Каждый консьюмер в группе получает свою партицию, обеспечивая балансировку нагрузки.

**Смещение (Offset)** — порядковый номер сообщения в партиции, который позволяет отслеживать, какие сообщения были прочитаны.

**Где сохраняется offset?** Kafka хранит offset во внутреннем топике `__consumer_offsets`.

---

### **Когда использовать Kafka?**

- Когда **консьюмер медленный, а продюсер быстрый**.
    
- Для **асинхронного взаимодействия** между сервисами.
    

#### **Как работает Kafka?**

1. В сервисе происходит событие.
    
2. Сообщение отправляется в Kafka (продюсер).
    
3. Консьюмер читает сообщение и обрабатывает его.
    

**Kafka vs RabbitMQ:**

- **Kafka** медленнее, но надежнее — записывает сообщения на диск.
    
- **RabbitMQ** быстрее, но менее надежен — сообщения не сохраняются на диск по умолчанию.
    

---

### **Основные компоненты Kafka**

#### **Топики (Topics)**

Топик — логическая структура, объединяющая сообщения по смыслу. Сообщения в топике хранятся в **партициях (Partitions)**.

#### **Партиции (Partitions)**

Каждый топик делится на партиции, что позволяет масштабировать Kafka.

- Партиции могут читаться несколькими консьюмерами из одной группы.
    
- Каждая партиция хранится на **брокерах (Brokers)**.
    

#### **Брокеры (Brokers)**

Брокер — сервер, который хранит партиции и управляет их распределением.

#### **Контроллер (Controller)**

Один из брокеров выбирается контроллером, который управляет лидерством партиций.

#### **Offset (Смещение сообщений)**

Каждое сообщение имеет **уникальный offset** в рамках своей партиции.

---

### **Механизм параллелизации в Kafka**

![[Untitled 1.png]]

- **Одну партицию может читать только один консьюмер в группе**.
    
- **Если консьюмеров больше, чем партиций, часть из них будет простаивать**.
    
- **Если консьюмеров меньше, чем партиций, один консьюмер может обрабатывать несколько партиций**.
    

---

### **Вопросы на собеседованиях**

#### **1. Может ли партиция отправляться не в группу консюмера, а в отдельный консюмер?**

Да, если у консюмера уникальный `group_id`, он будет получать все сообщения из партиции.

#### **2. Как продюсер определяет, в какую партицию писать?**

- Если передан ключ, Kafka использует хеширование.
    
- Если ключ не указан, Kafka распределяет сообщения равномерно.
    

#### **3. Что происходит, если у меня 5 партиций и 10 консюмеров?**

- Kafka назначит 5 консюмеров по одной партиции.
    
- Оставшиеся 5 консюмеров будут ждать освобождения партиций.
    

#### **4. Какую гарантию доставки сообщений вы использовали?**

Наиболее часто используется **At least once (по умолчанию)**, но можно настроить **Exactly once**.

---